// ===================================================================================
// LINK DA PLANILHA CORRIGIDO
// O link da sua planilha já está no formato correto para o dashboard funcionar.
// ===================================================================================
const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/15G9YGn6BJ89bpx6MkZBhOiRiwiSPOX3qZ4A8SQvf1Wg/pub?output=csv'; // Link da sua planilha, já no formato correto.

// ===================================================================================
// PASSO 2: CONFIGURAÇÃO DA API GEMINI (Opcional)
// Se você quiser usar a análise por IA, gere uma chave de API no Google AI Studio
// e cole-a aqui. A funcionalidade de IA não funcionará sem isso.
// ===================================================================================
const GEMINI_API_KEY = ""; // <--- INSIRA SUA CHAVE DA API DO GOOGLE AI STUDIO AQUI

// Carrega a API de visualização do Google Charts
google.charts.load('current', {
    'packages': ['corechart', 'pie'],
    'language': 'pt-BR'
});

// Define a função que será chamada quando a API de gráficos estiver pronta
google.charts.setOnLoadCallback(fetchAndProcessData);

/**
 * Função principal que busca os dados da planilha e inicia o processamento.
 */
async function fetchAndProcessData() {
    // VERIFICAÇÃO IMPORTANTE: Checa se o link da planilha foi alterado.
    if (GOOGLE_SHEET_URL === 'COLE_AQUI_O_LINK_CSV_PUBLICADO_DA_SUA_PLANILHA' || !GOOGLE_SHEET_URL) {
        document.body.innerHTML = `<h1 style="color: red;">CONFIGURAÇÃO NECESSÁRIA</h1><p style="text-align: center; font-size: 1.2rem;">Por favor, abra o arquivo <strong>script.js</strong> e insira o link da sua planilha Google Sheets na variável 'GOOGLE_SHEET_URL'.</p>`;
        console.error("ERRO: A URL da planilha não foi configurada.");
        return;
    }

    try {
        const response = await fetch(GOOGLE_SHEET_URL);
        if (!response.ok) {
            throw new Error(`Erro na rede ao buscar a planilha: ${response.statusText}. Verifique se a planilha está 'Publicada na web'.`);
        }
        const csvText = await response.text();
        
        const allRows = csvText.split(/\r?\n/).map(row => row.split(','));
        const dataRows = allRows.slice(1).filter(row => row.length > 1 && row[0]);
        
        if (dataRows.length === 0) {
             throw new Error("Nenhum dado encontrado na planilha. Verifique se ela não está vazia ou se o link CSV está correto.");
        }

        renderDashboard(dataRows);

    } catch (error) {
        console.error('Falha ao buscar ou processar os dados da planilha:', error);
        document.body.innerHTML = `<h1 style="color: red;">Erro ao carregar os dados</h1><p style="text-align: center; font-size: 1.2rem;">Verifique se o link da planilha está correto e se ela foi publicada corretamente como CSV. Detalhes do erro: ${error.message}</p>`;
    }
}

/**
 * Processa os dados brutos e renderiza os componentes do dashboard.
 * @param {string[][]} data - Os dados da planilha como um array de linhas.
 */
function renderDashboard(data) {
    const COLS = {
        DATA: 0, CONSULTOR: 1, INDICACAO: 2, HORA: 3,
        SITUACAO: 4, CONTATO: 5, OBSERVACAO: 6
    };

    const totalLeads = data.length;
    const emNegociacao = data.filter(row => row[COLS.SITUACAO]?.trim().toUpperCase() === 'NEGOCIAÇÃO').length;
    const semPossibilidade = data.filter(row => row[COLS.SITUACAO]?.trim().toUpperCase() === 'SEM POSSIBILIDADE').length;

    document.getElementById('total-leads').innerText = totalLeads;
    document.getElementById('em-negociacao').innerText = emNegociacao;
    document.getElementById('sem-possibilidade').innerText = semPossibilidade;
    
    const countOccurrences = (colIndex) => {
        const counts = new Map();
        data.forEach(row => {
            const key = row[colIndex]?.trim();
            if (key) {
                counts.set(key, (counts.get(key) || 0) + 1);
            }
        });
        return [['Categoria', 'Quantidade'], ...Array.from(counts.entries())];
    };

    const situacaoData = countOccurrences(COLS.SITUACAO);
    const consultorData = countOccurrences(COLS.CONSULTOR);
    const origemData = countOccurrences(COLS.INDICACAO);

    drawPieChart('situacao_chart_div', 'Distribuição por Situação', situacaoData);
    drawBarChart('consultor_chart_div', 'Leads por Consultor', consultorData);
    drawBarChart('origem_chart_div', 'Leads por Origem (Indicação)', origemData);

    // Configura a funcionalidade do Gemini
    setupGeminiFeature({ totalLeads, emNegociacao, semPossibilidade, origemData, situacaoData });
}

/**
 * Configura o botão e a lógica para chamar a API do Gemini.
 * @param {object} dashboardData - Um objeto contendo os dados do dashboard.
 */
function setupGeminiFeature(dashboardData) {
    const analysisButton = document.getElementById('gemini-analysis-button');
    const resultContainer = document.getElementById('gemini-analysis-result');

    analysisButton.addEventListener('click', async () => {
        if (!GEMINI_API_KEY) {
            resultContainer.innerHTML = '<p style="color: red;"><strong>Erro:</strong> A chave da API do Gemini não foi configurada no arquivo script.js.</p>';
            return;
        }

        analysisButton.disabled = true;
        resultContainer.innerHTML = '<div class="loader" style="margin: auto;"></div>';

        const prompt = `
            Você é um analista de vendas sênior e coach de equipe. Analise os seguintes dados de um dashboard de leads:
            - Total de Leads: ${dashboardData.totalLeads}
            - Leads em Negociação: ${dashboardData.emNegociacao}
            - Leads "Sem Possibilidade": ${dashboardData.semPossibilidade}
            - Distribuição de Leads por Origem: ${JSON.stringify(dashboardData.origemData.slice(1))}
            - Distribuição de Leads por Situação: ${JSON.stringify(dashboardData.situacaoData.slice(1))}

            Com base nesses dados, forneça 3 insights acionáveis e motivacionais para a equipe de vendas em formato de lista. 
            Seja conciso e direto. Não adicione introduções ou conclusões, apenas a lista.
            Exemplo de formato:
            - **Foco no Canal X:** Parece que [nome do canal] está trazendo muitos leads. Vamos dobrar a aposta aqui!
            - **Revisar Perdidos:** Temos [número] leads como "sem possibilidade". Que tal uma força-tarefa para reanalisar os motivos?
            - **Acelerar Negociações:** Com [número] leads em negociação, o desafio é manter o ritmo. Vamos criar um plano de ação para cada um.
        `;

        try {
            const resultText = await callGeminiAPI(prompt);
            const formattedText = resultText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\* (.*?)(?=\n\* |$)/g, '<li>$1</li>');
            
            resultContainer.innerHTML = `<ul>${formattedText}</ul>`;

        } catch (error) {
            console.error("Erro ao chamar a API Gemini:", error);
            resultContainer.innerHTML = `<p style="color: red;"><strong>Erro:</strong> Não foi possível obter a análise. Tente novamente mais tarde.</p>`;
        } finally {
            analysisButton.disabled = false;
        }
    });
}

/**
 * Chama a API do Gemini para gerar conteúdo.
 * @param {string} prompt - O prompt para enviar ao modelo.
 * @returns {Promise<string>} O texto gerado pelo modelo.
 */
async function callGeminiAPI(prompt) {
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
    
    const payload = {
        contents: [{
            parts: [{ text: prompt }]
        }]
    };

    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    if (!response.ok) {
        const errorBody = await response.text();
        throw new Error(`Erro na API: ${response.statusText} - ${errorBody}`);
    }

    const result = await response.json();
    return result.candidates[0].content.parts[0].text;
}


// Funções de desenho de gráficos (sem alteração)
function drawPieChart(elementId, title, dataArray) {
    const dataTable = google.visualization.arrayToDataTable(dataArray);
    const options = {
        title: title,
        pieHole: 0.4,
        titleTextStyle: { fontSize: 18, bold: true },
        legend: { position: 'bottom' },
        chartArea: { width: '90%', height: '80%' }
    };
    const chart = new google.visualization.PieChart(document.getElementById(elementId));
    chart.draw(dataTable, options);
}

function drawBarChart(elementId, title, dataArray) {
    const dataTable = google.visualization.arrayToDataTable(dataArray);
    const options = {
        title: title,
        titleTextStyle: { fontSize: 18, bold: true },
        legend: { position: 'none' },
        hAxis: { title: 'Quantidade' },
        chartArea: { width: '70%', height: '80%' }
    };
    const chart = new google.visualization.BarChart(document.getElementById(elementId));
    chart.draw(dataTable, options);
}
