<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Leads Interativo - Revive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .loader {
            border: 4px solid #d1d5db;
            border-top: 4px solid #818cf8; /* brand-primary-light */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-legend ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .custom-legend li {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 8px;
            transition: color 0.2s;
            color: #4b5563; /* text-gray-600 */
        }
        .custom-legend li.hidden-item {
            text-decoration: line-through;
            color: #9ca3af; /* text-gray-400 */
        }
        .custom-legend .legend-swatch {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-right: 10px;
        }
        .header-bg {
            background-color: #6366f1; /* brand-primary */
            clip-path: polygon(0 0, 100% 0, 100% 90%, 0 100%);
            padding-bottom: 5rem; 
        }
    </style>
    <script>
        // Customizing Tailwind with your brand colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#6366f1', // Lilás principal do logo
                        'brand-primary-light': '#818cf8',
                        'brand-primary-dark': '#4f46e5',
                        'brand-secondary': '#f4f4f5', // Um cinza bem claro
                        'brand-text': '#374151', // Cinza escuro para texto
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-brand-secondary text-brand-text">

    <div class="relative">
        <!-- Header with brand style -->
        <div class="header-bg relative z-10">
            <div class="container mx-auto p-4 md:p-8">
                 <header class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-white">ReVive Leads Digitais</h1>
                        <p class="text-indigo-200">Painel de Análise de Desempenho</p>
                    </div>
                     <div class="flex items-center gap-4">
                        <button id="strategic-analysis-btn" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                            ✨ Análise Estratégica
                        </button>
                        <!-- NOVO BOTÃO ADICIONADO AQUI -->
                        <button id="consultant-helper-btn" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                            ✨ Ajuda Consultor
                        </button>
                        <a href="https://revivemarketing.github.io/Tarefas-pendencias/" target="_blank" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition-colors">TAREFA</a>
                         <button id="refresh-btn" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                            Atualizar
                        </button>
                    </div>
                </header>
            </div>
        </div>

        <div class="container mx-auto p-4 md:p-8 -mt-20 relative z-20">
            <!-- Seção de Filtros -->
            <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="flex flex-col gap-4">
                    <!-- Row 1: Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <select id="filter-consultor" class="bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-primary-light w-full">
                            <option value="">Todos os Consultores</option>
                        </select>
                        <select id="filter-situacao" class="bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-primary-light w-full">
                            <option value="">Todas as Situações</option>
                        </select>
                        <div class="flex items-center gap-2">
                            <label for="start-date" class="text-sm text-gray-600">De:</label>
                            <input type="date" id="start-date" class="bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-gray-700 w-full">
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="end-date" class="text-sm text-gray-600">Até:</label>
                            <input type="date" id="end-date" class="bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-gray-700 w-full">
                        </div>
                    </div>
                    <!-- Row 2: Buttons -->
                    <div class="flex justify-end gap-4">
                        <button id="filter-btn" class="bg-brand-primary hover:bg-brand-primary-dark text-white font-bold py-2 px-4 rounded-lg transition-colors">Filtrar</button>
                        <button id="clear-filter-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">Limpar</button>
                    </div>
                </div>
            </div>

            <!-- Seção de Métricas (KPIs) -->
            <div id="kpi-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Os cards de KPI serão inseridos aqui pelo JavaScript -->
            </div>
            
            <!-- Seção de Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-3">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text">Leads por Situação</h2>
                    <div class="flex flex-col md:flex-row gap-6 items-center">
                        <div class="relative h-64 w-64 md:h-72 md:w-72 flex-shrink-0">
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div id="status-chart-legend" class="custom-legend w-full max-h-72 overflow-y-auto pr-2"></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text">Leads por Indicação</h2>
                     <div class="relative h-72 w-full mx-auto" style="max-width: 350px;">
                        <canvas id="sourceChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4 text-brand-text">Eficácia da Fonte de Leads</h2>
                <div class="relative h-64">
                    <canvas id="sourceConversionChart"></canvas>
                </div>
            </div>

            <!-- Tabela de Leads -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                 <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-brand-text">Lista de Leads</h2>
                    <span id="table-results-count" class="text-sm text-gray-500"></span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 font-semibold text-gray-600">Data</th>
                                <th class="p-4 font-semibold text-gray-600">Consultor</th>
                                <th class="p-4 font-semibold text-gray-600">Indicação</th>
                                <th class="p-4 font-semibold text-gray-600">Situação</th>
                                <th class="p-4 font-semibold text-gray-600">Contato</th>
                                <th class="p-4 font-semibold text-gray-600 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="leads-table-body" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                     <div id="loading-state" class="text-center p-8 text-gray-500">
                        <div class="loader mx-auto mb-4"></div>
                        <p>A carregar dados da planilha...</p>
                    </div>
                     <div id="no-results" class="text-center p-8 text-gray-500 hidden">
                        <p>Nenhum lead encontrado com os filtros aplicados.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="observation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl transform transition-all">
            <h2 class="text-2xl font-bold mb-4 text-brand-text">Observações do Lead</h2>
            <div id="observation-content" class="bg-gray-100 rounded-lg p-4 text-gray-700 whitespace-pre-wrap max-h-48 overflow-y-auto"></div>
            
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex items-center gap-4 mb-4 flex-wrap">
                    <button id="summarize-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 text-sm transition-colors">
                        ✨ Resumir
                    </button>
                    <button id="suggest-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 text-sm transition-colors">
                        ✨ Sugerir Próximo Passo
                    </button>
                </div>
                <div id="gemini-result-container" class="bg-gray-50 rounded-lg p-4 hidden min-h-[80px]">
                    <div id="gemini-loader" class="hidden mx-auto w-8 h-8">
                        <div class="loader"></div>
                    </div>
                    <div id="gemini-result-content" class="text-gray-700 whitespace-pre-wrap prose"></div>
                </div>
            </div>

            <div class="flex justify-end mt-6">
                <button id="close-observation-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <div id="strategic-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-3xl transform transition-all max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-brand-text">Análise Estratégica dos Leads</h2>
            <p class="text-gray-500 mb-4">A IA analisou todos os leads atuais para fornecer os seguintes insights.</p>
            <div id="strategic-content" class="bg-gray-100 rounded-lg p-4 text-gray-700 whitespace-pre-wrap overflow-y-auto flex-grow">
                <div id="strategic-loader" class="hidden mx-auto w-8 h-8">
                    <div class="loader"></div>
                </div>
                <div id="strategic-result-content" class="text-gray-700 whitespace-pre-wrap prose"></div>
            </div>
            <!-- SEÇÃO DO BOTÃO DE EXPORTAR MODIFICADA -->
            <div class="flex justify-between items-center mt-6">
                <button id="export-pdf-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>
                    Exportar para PDF
                </button>
                <button id="close-strategic-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <!-- NOVA JANELA MODAL "AJUDA CONSULTOR" ADICIONADA AQUI -->
    <div id="consultant-helper-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-3xl transform transition-all max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-2 text-brand-text">Assistente de Vendas IA</h2>
            <p class="text-gray-500 mb-4">Cole a dúvida ou o cenário do seu cliente abaixo para receber uma sugestão de abordagem.</p>
            
            <textarea id="consultant-query-input" class="w-full h-32 bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-primary-light" placeholder="Ex: O cliente disse que o consórcio não vale a pena porque não sabe quando será contemplado. O que eu respondo?"></textarea>
            
            <div class="my-4">
                <button id="get-suggestion-btn" class="bg-brand-primary hover:bg-brand-primary-dark text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                    Gerar Sugestão
                </button>
            </div>

            <div id="consultant-helper-content" class="bg-gray-100 rounded-lg p-4 text-gray-700 whitespace-pre-wrap overflow-y-auto flex-grow min-h-[150px]">
                <div id="consultant-helper-loader" class="hidden mx-auto w-8 h-8">
                    <div class="loader"></div>
                </div>
                <div id="consultant-helper-result-content" class="text-gray-700 whitespace-pre-wrap prose"></div>
            </div>

            <div class="flex justify-end mt-6">
                <button id="close-consultant-helper-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURAÇÕES DAS APIS ---
            const GOOGLE_SHEETS_API_KEY = 'AIzaSyAx8GJ2p-HNzwJwPljcgKS0QDNmJuy7NZE';
            const SPREADSHEET_ID = '15G9YGn6BJ89bpx6MkZBhOiRiwiSPOX3qZ4A8SQvf1Wg';
            // MODIFICADO: Lista de abas para buscar os dados. Adicione mais nomes aqui se precisar.
            const SHEET_NAMES = ['SETEMBRO', 'OUTUBRO']; 
            const RANGE_ADDRESS = 'A2:H';
            
            const GEMINI_API_KEY = "AIzaSyD2j2WDRWUfainGfljYk3AzggdzL8nSU7c"; 

            let leads = []; 
            let currentLeadInView = null;

            // --- ELEMENTOS DO DOM ---
            const tableBody = document.getElementById('leads-table-body');
            const kpiContainer = document.getElementById('kpi-container');
            const filterConsultor = document.getElementById('filter-consultor');
            const filterSituacao = document.getElementById('filter-situacao');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const filterBtn = document.getElementById('filter-btn');
            const clearFilterBtn = document.getElementById('clear-filter-btn');
            const noResultsDiv = document.getElementById('no-results');
            const loadingStateDiv = document.getElementById('loading-state');
            const tableResultsCount = document.getElementById('table-results-count');
            const observationModal = document.getElementById('observation-modal');
            const observationContent = document.getElementById('observation-content');
            const closeObservationBtn = document.getElementById('close-observation-btn');
            const strategicModal = document.getElementById('strategic-modal');
            const closeStrategicBtn = document.getElementById('close-strategic-btn');
            const strategicAnalysisBtn = document.getElementById('strategic-analysis-btn');
            const summarizeBtn = document.getElementById('summarize-btn');
            const suggestBtn = document.getElementById('suggest-btn');
            const geminiResultContainer = document.getElementById('gemini-result-container');
            const geminiLoader = document.getElementById('gemini-loader');
            const geminiResultContent = document.getElementById('gemini-result-content');
            const strategicLoader = document.getElementById('strategic-loader');
            const strategicResultContent = document.getElementById('strategic-result-content');
            const refreshBtn = document.getElementById('refresh-btn');

            // Gráficos
            let statusChartInstance, sourceChartInstance, sourceConversionChartInstance;

            // --- FUNÇÕES ---
            const callGeminiAPI = async (prompt, resultContainer, loaderElement, contentElement) => {
                if (!GEMINI_API_KEY) {
                    contentElement.textContent = 'Erro: A chave da API Gemini não foi configurada.';
                    return;
                }
                resultContainer.classList.remove('hidden');
                loaderElement.classList.remove('hidden');
                contentElement.innerHTML = '';
                const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'A resposta da API não foi bem-sucedida.');
                    }
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        contentElement.innerHTML = marked.parse(text);
                    } else {
                        throw new Error('Não foi possível extrair o texto da resposta da API.');
                    }
                } catch (error) {
                    console.error("Erro ao chamar a API Gemini:", error);
                    contentElement.textContent = `Ocorreu um erro: ${error.message}`;
                } finally {
                    loaderElement.classList.add('hidden');
                }
            };
            
            const parseDate = (dateString) => {
                if (!dateString || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) return null;
                const [day, month, year] = dateString.split('/');
                return new Date(year, month - 1, day);
            };
            
            // MODIFICADO: Função para buscar dados de múltiplas abas da planilha
            const fetchSheetData = async () => {
                loadingStateDiv.classList.remove('hidden');
                tableBody.innerHTML = '';
                noResultsDiv.classList.add('hidden');
                try {
                    // Cria uma lista de URLs, uma para cada aba da planilha
                    const urls = SHEET_NAMES.map(sheetName => {
                        const fullRange = `'${sheetName}'!${RANGE_ADDRESS}`;
                        return `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(fullRange)}?key=${GOOGLE_SHEETS_API_KEY}`;
                    });

                    // Busca os dados de todas as URLs em paralelo para maior eficiência
                    const responses = await Promise.all(urls.map(url => fetch(url)));

                    // Verifica se todas as respostas foram bem-sucedidas
                    for (const response of responses) {
                        if (!response.ok) {
                            const errorData = await response.json();
                            const errorMessage = errorData.error?.message || `Erro na API: ${response.status} ${response.statusText}`;
                            throw new Error(errorMessage);
                        }
                    }

                    // Extrai o conteúdo JSON de todas as respostas
                    const jsonPromises = responses.map(response => response.json());
                    const results = await Promise.all(jsonPromises);

                    // Combina os dados de todas as abas em uma única lista (array)
                    const sheetValues = results.flatMap(data => data.values || []);

                    if (sheetValues.length === 0) {
                        leads = [];
                        updateDashboard(leads);
                        return;
                    }

                    // Mapeia os dados combinados para o formato de objeto que o painel usa
                    leads = sheetValues.map((row, index) => ({
                        id: index + 1,
                        data: row[0] || '',
                        consultor: (row[1] || '').trim().toUpperCase(),
                        indicacao: row[2] || '',
                        situacao: row[4] || 'Não definido',
                        contato: row[5] || '',
                        observacao: row[6] || '',
                        dataFechamento: row[7] || '',
                        dateObject: parseDate(row[0]),
                        dateObjectFechamento: parseDate(row[7])
                    })).filter(lead => lead.consultor); // Filtra linhas que possam estar vazias

                    populateConsultantFilter(leads);
                    populateSituationFilter(leads);
                    updateDashboard(leads);

                } catch (error) {
                    console.error("Falha ao buscar dados da planilha:", error);
                    loadingStateDiv.innerHTML = `<p class="text-red-500">Erro ao carregar dados: ${error.message}. <br>Verifique se a Chave de API é válida, se a API do Google Sheets está ativa e se as planilhas estão partilhadas publicamente.</p>`;
                } finally {
                     loadingStateDiv.classList.add('hidden');
                }
            };

            const populateConsultantFilter = (data) => {
                const consultants = [...new Set(data.map(lead => lead.consultor))];
                filterConsultor.innerHTML = '<option value="">Todos os Consultores</option>';
                consultants.sort().forEach(c => {
                    const option = document.createElement('option');
                    option.value = c;
                    option.textContent = c;
                    filterConsultor.appendChild(option);
                });
            };
            
            const populateSituationFilter = (data) => {
                const situations = [...new Set(data.map(lead => lead.situacao))];
                filterSituacao.innerHTML = '<option value="">Todas as Situações</option>';
                situations.sort().forEach(sit => {
                    const option = document.createElement('option');
                    option.value = sit;
                    option.textContent = sit;
                    filterSituacao.appendChild(option);
                });
            };

            const getStatusColor = (status) => {
                const lowerStatus = (status || '').toLowerCase().trim();
                switch (lowerStatus) {
                    case 'negociação': return 'bg-pink-500 text-white';
                    case 'fechado': return 'bg-green-600 text-white';
                    case 'sem possibilidade': return 'bg-red-600 text-white';
                    case 'duvida': return 'bg-blue-400 text-gray-900';
                    case 'letalk - negociação': return 'bg-purple-500 text-white';
                    case 'letalk - sem possibilidade': return 'bg-red-400 text-gray-900';
                    case 'letalk - fechado': return 'bg-green-400 text-gray-900';
                    case 'letalk - duvida': return 'bg-sky-400 text-gray-900';
                    case 'letalk': return 'bg-yellow-400 text-gray-900';
                    case 'aguardando resposta': return 'bg-gray-500 text-white';
                    default:
                        if (lowerStatus.includes('negocia')) return 'bg-yellow-500 text-gray-900';
                        if (lowerStatus.includes('sem possib')) return 'bg-red-500 text-white';
                        if (lowerStatus.includes('fechado')) return 'bg-green-500 text-white';
                        return 'bg-gray-600 text-white';
                }
            };
            
            const getStatusChartColor = (status) => {
                const lowerStatus = (status || '').toLowerCase().trim();
                switch (lowerStatus) {
                    case 'negociação': return '#ec4899';
                    case 'fechado': return '#16a34a';
                    case 'sem possibilidade': return '#dc2626';
                    case 'duvida': return '#60a5fa';
                    case 'letalk - negociação': return '#a855f7';
                    case 'letalk - sem possibilidade': return '#f87171';
                    case 'letalk - fechado': return '#4ade80';
                    case 'letalk - duvida': return '#38bdf8';
                    case 'letalk': return '#facc15';
                    case 'aguardando resposta': return '#6b7280';
                    default: return '#4b5563';
                }
            };

            const renderKpis = (data) => {
                const totalLeads = data.length;
                const emNegociacao = data.filter(l => (l.situacao || '').toLowerCase().includes('negocia')).length;
                const convertidos = data.filter(l => (l.situacao || '').toLowerCase().includes('fechado')).length;
                const perdidos = data.filter(l => (l.situacao || '').toLowerCase().includes('sem possib')).length;
                const conversionRate = totalLeads > 0 ? (convertidos / totalLeads) * 100 : 0;
                
                const leadsFechadosComData = data.filter(l => (l.situacao || '').toLowerCase().includes('fechado') && l.dateObject && l.dateObjectFechamento);
                let cicloVendasMedio = 0;
                if (leadsFechadosComData.length > 0) {
                    const totalDias = leadsFechadosComData.reduce((acc, lead) => {
                        const diffTime = Math.abs(lead.dateObjectFechamento - lead.dateObject);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        return acc + (diffDays > 0 ? diffDays : 1);
                    }, 0);
                    cicloVendasMedio = totalDias / leadsFechadosComData.length;
                }
                
                let conversionColor = 'text-red-500';
                if (conversionRate >= 6) {
                    conversionColor = 'text-green-500';
                } else if (conversionRate >= 5) {
                    conversionColor = 'text-yellow-500';
                }
                
                const kpis = [
                    { type: 'card', label: 'Total de Leads', value: totalLeads, color: 'text-blue-500', filterValue: '' },
                    { type: 'card', label: 'Em Negociação', value: emNegociacao, color: 'text-yellow-500', filterValue: 'negocia' },
                    { type: 'card', label: 'Leads Convertidos', value: convertidos, color: 'text-green-500', filterValue: 'fechado' },
                    { type: 'card', label: 'Leads Perdidos', value: perdidos, color: 'text-red-500', filterValue: 'sem possib' },
                    { type: 'rate', label: 'Taxa de Conversão', value: `${conversionRate.toFixed(1)}%`, color: conversionColor },
                    { type: 'cycle', label: 'Ciclo de Vendas (dias)', value: cicloVendasMedio.toFixed(1), color: 'text-cyan-500' },
                ];
                
                kpiContainer.innerHTML = kpis.map(kpi => {
                    const baseClasses = "bg-white p-6 rounded-lg shadow-md";
                    if (kpi.type === 'card') {
                        return `<div class="${baseClasses} cursor-pointer hover:shadow-lg transition-shadow" data-filter-value="${kpi.filterValue}"><h3 class="text-sm font-medium text-gray-500">${kpi.label}</h3><p class="text-3xl font-bold mt-2 ${kpi.color}">${kpi.value}</p></div>`;
                    }
                    return `<div class="${baseClasses}"><h3 class="text-sm font-medium text-gray-500">${kpi.label}</h3><p class="text-3xl font-bold mt-2 ${kpi.color}">${kpi.value}</p></div>`;
                }).join('');
            };
            
            const generateCustomLegend = (chart) => {
                const legendContainer = document.getElementById('status-chart-legend');
                const ul = document.createElement('ul');
                const legendItems = chart.options.plugins.legend.labels.generateLabels(chart);

                legendItems.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.onclick = () => {
                        chart.toggleDataVisibility(index);
                        li.classList.toggle('hidden-item');
                        chart.update();
                    };
                    const swatch = document.createElement('span');
                    swatch.className = 'legend-swatch';
                    swatch.style.backgroundColor = item.fillStyle;
                    const text = document.createTextNode(item.text);
                    li.appendChild(swatch);
                    li.appendChild(text);
                    ul.appendChild(li);
                });
                legendContainer.innerHTML = '';
                legendContainer.appendChild(ul);
            };

            const renderCharts = (data) => {
                const tooltipPercentage = { callbacks: { label: (c) => `${c.label}: ${c.raw.toFixed(1)} (${((c.raw/c.chart.getDatasetMeta(0).total)*100).toFixed(1)}%)` } };
                
                const statusCounts = data.reduce((acc, lead) => {
                    const situacao = lead.situacao || 'Não definido';
                    acc[situacao] = (acc[situacao] || 0) + 1;
                    return acc;
                }, {});
                const statusData = {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: Object.keys(statusCounts).map(s => getStatusChartColor(s)),
                        borderColor: '#fff', borderWidth: 4
                    }]
                };
                if(statusChartInstance) statusChartInstance.destroy();
                statusChartInstance = new Chart(document.getElementById('statusChart'), { type: 'doughnut', data: statusData, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false }, tooltip: tooltipPercentage } }, plugins: [{ afterDraw: (chart) => { if (chart.options.plugins.legend.display === false) generateCustomLegend(chart); } }]});
                
                const sourceCounts = data.reduce((acc, lead) => {
                    const indicacao = lead.indicacao || 'Não definido';
                    acc[indicacao] = (acc[indicacao] || 0) + 1;
                    return acc;
                }, {});
                const sourceData = {
                    labels: Object.keys(sourceCounts),
                    datasets: [{
                        data: Object.values(sourceCounts),
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#10b981', '#f97316', '#6366f1'],
                        borderColor: '#fff', borderWidth: 4
                    }]
                };
                if(sourceChartInstance) sourceChartInstance.destroy();
                sourceChartInstance = new Chart(document.getElementById('sourceChart'), { type: 'pie', data: sourceData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#4b5563' } }, tooltip: tooltipPercentage } } });
                
                const sourceConversionData = {};
                data.forEach(lead => {
                    const source = lead.indicacao || 'Não definido';
                    if (!sourceConversionData[source]) sourceConversionData[source] = { total: 0, converted: 0 };
                    sourceConversionData[source].total++;
                    if ((lead.situacao || '').toLowerCase().includes('fechado')) sourceConversionData[source].converted++;
                });
                const sourceLabels = Object.keys(sourceConversionData);
                const conversionRates = sourceLabels.map(s => (sourceConversionData[s].total > 0 ? (sourceConversionData[s].converted / sourceConversionData[s].total) * 100 : 0));
                const sourceConversionChartData = {
                    labels: sourceLabels,
                    datasets: [{
                        label: 'Taxa de Conversão (%)',
                        data: conversionRates,
                        backgroundColor: '#22c55e',
                        borderColor: '#16a34a',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                };
                if(sourceConversionChartInstance) sourceConversionChartInstance.destroy();
                sourceConversionChartInstance = new Chart(document.getElementById('sourceConversionChart'), { type: 'bar', data: sourceConversionChartData, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 100, ticks: { color: '#4b5563', callback: (v) => `${v}%` } }, y: { ticks: { color: '#4b5563' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Conversão: ${c.raw.toFixed(1)}%` } } } } });
            }

            const renderTable = (data) => {
                tableResultsCount.textContent = `${data.length} resultado(s) encontrado(s).`;
                if (data.length === 0) {
                    tableBody.innerHTML = '';
                    noResultsDiv.classList.remove('hidden');
                    return;
                }
                noResultsDiv.classList.add('hidden');
                tableBody.innerHTML = data.map(lead => `<tr class="hover:bg-gray-50"><td class="p-4">${lead.data}</td><td class="p-4">${lead.consultor}</td><td class="p-4">${lead.indicacao}</td><td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(lead.situacao)}">${lead.situacao}</span></td><td class="p-4">${lead.contato}</td><td class="p-4 text-center"><button class="text-brand-primary hover:text-brand-primary-dark" data-action="view" data-id="${lead.id}" title="Ver Observações"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.012 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg></button></td></tr>`).join('');
            };
            
            const applyFilters = () => {
                const consultor = filterConsultor.value;
                const situacao = filterSituacao.value;
                const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
                if (startDate) startDate.setHours(0, 0, 0, 0);
                if (endDate) endDate.setHours(23, 59, 59, 999);
                const filteredLeads = leads.filter(lead => (consultor ? lead.consultor === consultor : true) && (situacao ? lead.situacao === situacao : true) && (!startDate || (lead.dateObject && lead.dateObject >= startDate)) && (!endDate || (lead.dateObject && lead.dateObject <= endDate)));
                renderTable(filteredLeads);
                updateDashboard(filteredLeads, false);
            };
            
            const updateDashboard = (data, shouldUpdateTable = true) => {
                renderKpis(data);
                renderCharts(data);
                if (shouldUpdateTable) renderTable(data);
            }
            
            filterBtn.addEventListener('click', applyFilters);
            clearFilterBtn.addEventListener('click', () => {
                filterConsultor.value = '';
                filterSituacao.value = '';
                startDateInput.value = '';
                endDateInput.value = '';
                updateDashboard(leads);
            });
            refreshBtn.addEventListener('click', fetchSheetData);

            kpiContainer.addEventListener('click', (e) => {
                const kpiCard = e.target.closest('[data-filter-value]');
                if (!kpiCard) return;
                const filterValue = kpiCard.dataset.filterValue;
                if(filterValue === '') {
                    filterSituacao.value = '';
                } else {
                    const option = Array.from(filterSituacao.options).find(opt => opt.textContent.toLowerCase().includes(filterValue));
                    filterSituacao.value = option ? option.value : '';
                }
                applyFilters();
            });
            tableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button[data-action="view"]');
                if (!button) return;
                const id = button.dataset.id;
                const leadToView = leads.find(l => l.id == id);
                if (leadToView) {
                    currentLeadInView = leadToView;
                    observationContent.textContent = leadToView.observacao || 'Nenhuma observação registada.';
                    geminiResultContainer.classList.add('hidden');
                    geminiResultContent.innerHTML = '';
                    observationModal.classList.remove('hidden');
                }
            });
            summarizeBtn.addEventListener('click', () => {
                if (currentLeadInView?.observacao) {
                    const prompt = `Resuma as seguintes observações de um lead comercial em 2 ou 3 pontos principais, em português. Seja conciso e direto:\n\n"${currentLeadInView.observacao}"`;
                    callGeminiAPI(prompt, geminiResultContainer, geminiLoader, geminiResultContent);
                } else {
                    geminiResultContent.textContent = 'Não há observações para resumir.';
                    geminiResultContainer.classList.remove('hidden');
                }
            });
            suggestBtn.addEventListener('click', () => {
                if (currentLeadInView) {
                    const prompt = `Aja como um gestor de vendas experiente. Para um lead com a situação "${currentLeadInView.situacao}" e as seguintes observações: "${currentLeadInView.observacao || 'Nenhuma observação anterior'}", sugira um próximo passo claro e acionável para o consultor. Responda em português.`;
                    callGeminiAPI(prompt, geminiResultContainer, geminiLoader, geminiResultContent);
                }
            });
            strategicAnalysisBtn.addEventListener('click', () => {
                strategicModal.classList.remove('hidden');
                const dataToAnalyze = leads;
                if (dataToAnalyze.length === 0) {
                     strategicResultContent.textContent = "Não há dados de leads para analisar. Por favor, carregue os dados primeiro.";
                     return;
                }
                const leadsDataForPrompt = dataToAnalyze.map(l => ` - Situação: ${l.situacao}, Indicação: ${l.indicacao}, Consultor: ${l.consultor}`).join('\n');
                const prompt = `Aja como um diretor de vendas. Analise os seguintes dados de uma equipe comercial.\n\nDados:\n${leadsDataForPrompt}\n\nCom base nestes dados, identifique:\n1. **Pontos Fortes:** Quais são as fontes de leads (indicação) mais eficazes ou as situações que estão a levar a bons resultados?\n2. **Pontos Fracos:** Onde é que o processo de vendas parece estar a falhar? Há algum padrão nos leads perdidos ou estagnados?\n3. **Sugestão Acionável:** Dê uma sugestão estratégica e clara para a equipe melhorar os seus resultados no próximo mês.\n\nResponda em português (Brasil) com uma formatação clara usando títulos para cada secção.`;
                callGeminiAPI(prompt, document.getElementById('strategic-content'), strategicLoader, strategicResultContent);
            });
            function closeModal(modal) { modal.classList.add('hidden'); }
            closeObservationBtn.addEventListener('click', () => closeModal(observationModal));
            observationModal.addEventListener('click', (e) => { if (e.target === observationModal) closeModal(observationModal); });
            closeStrategicBtn.addEventListener('click', () => closeModal(strategicModal));
            strategicModal.addEventListener('click', (e) => { if (e.target === strategicModal) closeModal(strategicModal); });
            
            fetchSheetData();
        });
    </script>
</body>

</html>
