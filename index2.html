<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Leads Interativo com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .loader {
            border: 4px solid #4b5563;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for date inputs */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }
        /* Custom legend styles */
        .custom-legend ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .custom-legend li {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 8px;
            transition: color 0.2s;
        }
        .custom-legend li.hidden-item {
            text-decoration: line-through;
            color: #6b7280; /* text-gray-500 */
        }
        .custom-legend .legend-swatch {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-right: 10px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
            <div>
                 <h1 class="text-3xl font-bold text-white">Painel de Leads Online</h1>
                 <p class="text-gray-400">Dados sincronizados com o Google Sheets.</p>
            </div>
            <div class="flex items-center gap-4">
                 <button id="strategic-analysis-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                    ✨ Análise Estratégica
                </button>
                <button id="refresh-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                    Atualizar
                </button>
            </div>
        </header>

        <!-- Seção de Filtros -->
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6 flex flex-col md:flex-row items-center flex-wrap gap-4">
            <input type="text" id="filter-consultor" placeholder="Filtrar por consultor..." class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-auto">
            <select id="filter-situacao" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-auto">
                <option value="">Todas as Situações</option>
            </select>
            <div class="flex items-center gap-2">
                <label for="start-date" class="text-sm">De:</label>
                <input type="date" id="start-date" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
            </div>
            <div class="flex items-center gap-2">
                <label for="end-date" class="text-sm">Até:</label>
                <input type="date" id="end-date" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
            </div>
            <div class="flex items-center gap-4 ml-auto">
                <button id="filter-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Filtrar</button>
                <button id="clear-filter-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Limpar</button>
            </div>
        </div>

        <!-- Seção de Métricas (KPIs) -->
        <div id="kpi-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Os cards de KPI serão inseridos aqui pelo JavaScript -->
        </div>
        
        <!-- Seção de Gráficos -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
            <!-- Gráfico de Situação com Legenda Customizada -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-3">
                <h2 class="text-xl font-semibold mb-4">Leads por Situação</h2>
                <div class="flex flex-col md:flex-row gap-6 items-center">
                    <div class="relative h-64 w-64 md:h-72 md:w-72 flex-shrink-0">
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div id="status-chart-legend" class="custom-legend w-full max-h-72 overflow-y-auto pr-2"></div>
                </div>
            </div>
            <!-- Gráfico de Indicação -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Leads por Indicação</h2>
                 <div class="relative h-72 w-full mx-auto" style="max-width: 350px;">
                    <canvas id="sourceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabela de Leads -->
        <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
             <div class="p-4 bg-gray-700/50 flex justify-between items-center">
                <h2 class="text-xl font-semibold">Lista de Leads</h2>
                <span id="table-results-count" class="text-sm text-gray-400"></span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="p-4 font-semibold">Data</th>
                            <th class="p-4 font-semibold">Consultor</th>
                            <th class="p-4 font-semibold">Indicação</th>
                            <th class="p-4 font-semibold">Situação</th>
                            <th class="p-4 font-semibold">Contato</th>
                            <th class="p-4 font-semibold text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="leads-table-body" class="divide-y divide-gray-700">
                    </tbody>
                </table>
                 <div id="loading-state" class="text-center p-8 text-gray-400">
                    <div class="loader mx-auto mb-4" style="border-top-color: #3498db; width: 40px; height: 40px;"></div>
                    <p>A carregar dados da planilha...</p>
                </div>
                 <div id="no-results" class="text-center p-8 text-gray-400 hidden">
                    <p>Nenhum lead encontrado com os filtros aplicados.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para ver observações -->
    <div id="observation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-2xl transform transition-all">
            <h2 class="text-2xl font-bold mb-4 text-white">Observações do Lead</h2>
            <div id="observation-content" class="bg-gray-700 rounded-lg p-4 text-gray-300 whitespace-pre-wrap max-h-48 overflow-y-auto"></div>
            
            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="flex items-center gap-4 mb-4 flex-wrap">
                    <button id="summarize-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 text-sm transition-colors">
                        ✨ Resumir Observações
                    </button>
                    <button id="suggest-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 text-sm transition-colors">
                        ✨ Sugerir Próximo Passo
                    </button>
                </div>
                <div id="gemini-result-container" class="bg-gray-900/50 rounded-lg p-4 hidden min-h-[80px]">
                    <div id="gemini-loader" class="hidden mx-auto w-8 h-8">
                        <div class="loader"></div>
                    </div>
                    <div id="gemini-result-content" class="text-gray-300 whitespace-pre-wrap"></div>
                </div>
            </div>

            <div class="flex justify-end mt-6">
                <button id="close-observation-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Fechar</button>
            </div>
        </div>
    </div>

     <!-- Modal para Análise Estratégica -->
    <div id="strategic-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-3xl transform transition-all max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-white">Análise Estratégica dos Leads</h2>
            <p class="text-gray-400 mb-4">A IA analisou todos os leads atuais para fornecer os seguintes insights.</p>
            <div id="strategic-content" class="bg-gray-900/50 rounded-lg p-4 text-gray-300 whitespace-pre-wrap overflow-y-auto flex-grow">
                <div id="strategic-loader" class="hidden mx-auto w-8 h-8">
                    <div class="loader"></div>
                </div>
                <div id="strategic-result-content" class="text-gray-300 whitespace-pre-wrap"></div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-strategic-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Fechar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURAÇÕES DAS APIS ---
            const GOOGLE_SHEETS_API_KEY = 'AIzaSyAx8GJ2p-HNzwJwPljcgKS0QDNmJuy7NZE';
            const SPREADSHEET_ID = '15G9YGn6BJ89bpx6MkZBhOiRiwiSPOX3qZ4A8SQvf1Wg';
            const SHEET_NAME = 'SETEMBRO';
            const RANGE_ADDRESS = 'A2:G';
            
            const fullRange = `'${SHEET_NAME}'!${RANGE_ADDRESS}`;
            const SHEETS_API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(fullRange)}?key=${GOOGLE_SHEETS_API_KEY}`;
            
            const GEMINI_API_KEY = ""; 

            let leads = []; 
            let currentLeadInView = null;

            // --- ELEMENTOS DO DOM ---
            const tableBody = document.getElementById('leads-table-body');
            const kpiContainer = document.getElementById('kpi-container');
            const filterConsultor = document.getElementById('filter-consultor');
            const filterSituacao = document.getElementById('filter-situacao');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const filterBtn = document.getElementById('filter-btn');
            const clearFilterBtn = document.getElementById('clear-filter-btn');
            const noResultsDiv = document.getElementById('no-results');
            const loadingStateDiv = document.getElementById('loading-state');
            const refreshBtn = document.getElementById('refresh-btn');
            const tableResultsCount = document.getElementById('table-results-count');

            // Modais
            const observationModal = document.getElementById('observation-modal');
            const observationContent = document.getElementById('observation-content');
            const closeObservationBtn = document.getElementById('close-observation-btn');
            
            const strategicModal = document.getElementById('strategic-modal');
            const closeStrategicBtn = document.getElementById('close-strategic-btn');
            const strategicAnalysisBtn = document.getElementById('strategic-analysis-btn');

            // Gemini - Observação
            const summarizeBtn = document.getElementById('summarize-btn');
            const suggestBtn = document.getElementById('suggest-btn');
            const geminiResultContainer = document.getElementById('gemini-result-container');
            const geminiLoader = document.getElementById('gemini-loader');
            const geminiResultContent = document.getElementById('gemini-result-content');

            // Gemini - Estratégia
            const strategicLoader = document.getElementById('strategic-loader');
            const strategicResultContent = document.getElementById('strategic-result-content');

            // Gráficos
            let statusChartInstance, sourceChartInstance;

            // --- FUNÇÕES ---
            const callGeminiAPI = async (prompt, resultContainer, loaderElement, contentElement) => {
                resultContainer.classList.remove('hidden');
                loaderElement.classList.remove('hidden');
                contentElement.innerHTML = '';

                const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'A resposta da API não foi bem-sucedida.');
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        contentElement.textContent = text;
                    } else {
                        throw new Error('Não foi possível extrair o texto da resposta da API.');
                    }

                } catch (error) {
                    console.error("Erro ao chamar a API Gemini:", error);
                    contentElement.textContent = `Ocorreu um erro: ${error.message}`;
                } finally {
                    loaderElement.classList.add('hidden');
                }
            };
            
            const parseDate = (dateString) => {
                if (!dateString || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) return null;
                const [day, month, year] = dateString.split('/');
                return new Date(year, month - 1, day);
            };

            const fetchSheetData = async () => {
                loadingStateDiv.classList.remove('hidden');
                tableBody.innerHTML = '';
                noResultsDiv.classList.add('hidden');
                
                try {
                    const response = await fetch(SHEETS_API_URL);
                    const data = await response.json();

                    if (!response.ok) {
                        const errorMessage = data.error?.message || `Erro na API: ${response.status} ${response.statusText}`;
                        throw new Error(errorMessage);
                    }
                    
                    const sheetValues = data.values || [];
                    leads = sheetValues.map((row, index) => ({
                        id: index + 1,
                        data: row[0] || '',
                        consultor: row[1] || '',
                        indicacao: row[2] || '',
                        situacao: row[4] || 'Não definido',
                        contato: row[5] || '',
                        observacao: row[6] || '',
                        dateObject: parseDate(row[0])
                    })).filter(lead => lead.consultor);
                    
                    populateSituationFilter(leads);
                    updateDashboard(leads);

                } catch (error) {
                    console.error("Falha ao buscar dados da planilha:", error);
                    loadingStateDiv.innerHTML = `<p class="text-red-400">Erro ao carregar dados: ${error.message}. <br>Verifique se a Chave de API é válida, se a API do Google Sheets está ativa e se a planilha está partilhada publicamente.</p>`;
                } finally {
                     loadingStateDiv.classList.add('hidden');
                }
            };
            
            const populateSituationFilter = (data) => {
                const situations = [...new Set(data.map(lead => lead.situacao))];
                filterSituacao.innerHTML = '<option value="">Todas as Situações</option>';
                situations.sort().forEach(sit => {
                    const option = document.createElement('option');
                    option.value = sit;
                    option.textContent = sit;
                    filterSituacao.appendChild(option);
                });
            };

            const getStatusColor = (status) => {
                const lowerStatus = (status || '').toLowerCase().trim();
                
                // Mapeamento de cores baseado nas imagens do Google Sheets
                switch (lowerStatus) {
                    case 'negociação': return 'bg-pink-500 text-white';
                    case 'fechado': return 'bg-green-600 text-white';
                    case 'sem possibilidade': return 'bg-red-600 text-white';
                    case 'duvida': return 'bg-blue-400 text-gray-900';
                    case 'letalk - negociação': return 'bg-purple-500 text-white';
                    case 'letalk - sem possibilidade': return 'bg-red-400 text-gray-900';
                    case 'letalk - fechado': return 'bg-green-400 text-gray-900';
                    case 'letalk - duvida': return 'bg-sky-400 text-gray-900';
                    case 'letalk': return 'bg-yellow-400 text-gray-900';
                    case 'aguardando resposta': return 'bg-gray-500 text-white';
                    
                    // Fallbacks genéricos
                    default:
                        if (lowerStatus.includes('negocia')) return 'bg-yellow-500 text-gray-900';
                        if (lowerStatus.includes('sem possib')) return 'bg-red-500 text-white';
                        if (lowerStatus.includes('fechado')) return 'bg-green-500 text-white';
                        return 'bg-gray-600 text-white';
                }
            };
            
            const getStatusChartColor = (status) => {
                const lowerStatus = (status || '').toLowerCase().trim();

                switch (lowerStatus) {
                    case 'negociação': return 'rgba(236, 72, 153, 0.8)'; // Pink
                    case 'fechado': return 'rgba(22, 163, 74, 0.8)'; // Green
                    case 'sem possibilidade': return 'rgba(220, 38, 38, 0.8)'; // Red
                    case 'duvida': return 'rgba(96, 165, 250, 0.8)'; // Blue
                    case 'letalk - negociação': return 'rgba(168, 85, 247, 0.8)'; // Purple
                    case 'letalk - sem possibilidade': return 'rgba(248, 113, 113, 0.8)'; // Light Red
                    case 'letalk - fechado': return 'rgba(74, 222, 128, 0.8)'; // Light Green
                    case 'letalk - duvida': return 'rgba(56, 189, 248, 0.8)'; // Sky Blue
                    case 'letalk': return 'rgba(250, 204, 21, 0.8)'; // Yellow
                    case 'aguardando resposta': return 'rgba(107, 114, 128, 0.8)'; // Gray

                    default:
                        if (lowerStatus.includes('negocia')) return 'rgba(234, 179, 8, 0.8)';
                        if (lowerStatus.includes('sem possib')) return 'rgba(239, 68, 68, 0.8)';
                        if (lowerStatus.includes('fechado')) return 'rgba(34, 197, 94, 0.8)';
                        return 'rgba(75, 85, 99, 0.8)';
                }
            };

            const renderKpis = (data) => {
                const totalLeads = data.length;
                const emNegociacao = data.filter(l => (l.situacao || '').toLowerCase().includes('negocia')).length;
                const convertidos = data.filter(l => (l.situacao || '').toLowerCase().includes('fechado')).length;
                const perdidos = data.filter(l => (l.situacao || '').toLowerCase().includes('sem possib')).length;

                const kpis = [
                    { label: 'Total de Leads', value: totalLeads, color: 'text-blue-400', filterValue: '' },
                    { label: 'Em Negociação', value: emNegociacao, color: 'text-yellow-400', filterValue: 'negocia' },
                    { label: 'Leads Convertidos', value: convertidos, color: 'text-green-400', filterValue: 'fechado' },
                    { label: 'Leads Perdidos', value: perdidos, color: 'text-red-400', filterValue: 'sem possib' },
                ];
                
                kpiContainer.innerHTML = kpis.map(kpi => `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg cursor-pointer hover:bg-gray-700/50 transition-colors" data-filter-value="${kpi.filterValue}">
                        <h3 class="text-sm font-medium text-gray-400">${kpi.label}</h3>
                        <p class="text-3xl font-bold mt-2 ${kpi.color}">${kpi.value}</p>
                    </div>
                `).join('');
            };
            
            const generateCustomLegend = (chart) => {
                const legendContainer = document.getElementById('status-chart-legend');
                const ul = document.createElement('ul');

                const legendItems = chart.options.plugins.legend.labels.generateLabels(chart);

                legendItems.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.onclick = () => {
                        const isVisible = chart.isDatasetVisible(item.datasetIndex);
                        chart.toggleDataVisibility(index);
                        li.classList.toggle('hidden-item', isVisible);
                        chart.update();
                    };

                    const swatch = document.createElement('span');
                    swatch.className = 'legend-swatch';
                    swatch.style.backgroundColor = item.fillStyle;

                    const text = document.createTextNode(item.text);

                    li.appendChild(swatch);
                    li.appendChild(text);
                    ul.appendChild(li);
                });

                legendContainer.innerHTML = '';
                legendContainer.appendChild(ul);
            };

            const renderCharts = (data) => {
                const tooltipPercentage = {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = context.chart.getDatasetMeta(0).total;
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                            return `${label}: ${value} (${percentage})`;
                        }
                    }
                };

                // --- Gráfico de Situação ---
                const statusCounts = data.reduce((acc, lead) => {
                    const situacao = lead.situacao || 'Não definido';
                    acc[situacao] = (acc[situacao] || 0) + 1;
                    return acc;
                }, {});

                const statusData = {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: Object.keys(statusCounts).map(s => getStatusChartColor(s)),
                        borderColor: '#1f2937', borderWidth: 3
                    }]
                };
                
                if(statusChartInstance) statusChartInstance.destroy();
                statusChartInstance = new Chart(document.getElementById('statusChart'), { 
                    type: 'doughnut', 
                    data: statusData, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: { 
                            legend: { display: false },
                            tooltip: tooltipPercentage
                        } 
                    },
                    plugins: [{
                        afterDraw: (chart) => {
                            if (chart.options.plugins.legend.display === false) {
                                generateCustomLegend(chart);
                            }
                        }
                    }]
                });

                // --- Gráfico de Indicação ---
                const sourceCounts = data.reduce((acc, lead) => {
                    const indicacao = lead.indicacao || 'Não definido';
                    acc[indicacao] = (acc[indicacao] || 0) + 1;
                    return acc;
                }, {});

                const sourceData = {
                    labels: Object.keys(sourceCounts),
                    datasets: [{
                        data: Object.values(sourceCounts),
                        backgroundColor: ['rgba(59, 130, 246, 0.8)','rgba(139, 92, 246, 0.8)','rgba(236, 72, 153, 0.8)','rgba(16, 185, 129, 0.8)','rgba(245, 158, 11, 0.8)','rgba(99, 102, 241, 0.8)'],
                        borderColor: '#1f2937', borderWidth: 3
                    }]
                };

                if(sourceChartInstance) sourceChartInstance.destroy();
                sourceChartInstance = new Chart(document.getElementById('sourceChart'), { 
                    type: 'pie', 
                    data: sourceData, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'bottom', labels: { color: '#d1d5db' } },
                            tooltip: tooltipPercentage
                        } 
                    } 
                });
            }

            const renderTable = (data) => {
                tableResultsCount.textContent = `${data.length} resultado(s) encontrado(s).`;
                if (data.length === 0) {
                    tableBody.innerHTML = '';
                    noResultsDiv.classList.remove('hidden');
                    return;
                }
                noResultsDiv.classList.add('hidden');
                tableBody.innerHTML = data.map(lead => `
                    <tr class="hover:bg-gray-700/50">
                        <td class="p-4">${lead.data}</td>
                        <td class="p-4">${lead.consultor}</td>
                        <td class="p-4">${lead.indicacao}</td>
                        <td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(lead.situacao)}">${lead.situacao}</span></td>
                        <td class="p-4">${lead.contato}</td>
                        <td class="p-4 text-center">
                            <button class="text-blue-400 hover:text-blue-300 mr-2" data-action="view" data-id="${lead.id}" title="Ver Observações">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.012 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            };
            
            const applyFilters = () => {
                const consultor = filterConsultor.value.toLowerCase();
                const situacao = filterSituacao.value;
                const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

                if (startDate) startDate.setHours(0, 0, 0, 0);
                if (endDate) endDate.setHours(23, 59, 59, 999);

                const filteredLeads = leads.filter(lead => {
                    const consultorMatch = (lead.consultor || '').toLowerCase().includes(consultor);
                    const situacaoMatch = situacao ? lead.situacao === situacao : true;
                    const dateMatch = (!startDate || (lead.dateObject && lead.dateObject >= startDate)) && 
                                      (!endDate || (lead.dateObject && lead.dateObject <= endDate));

                    return consultorMatch && situacaoMatch && dateMatch;
                });
                updateDashboard(filteredLeads);
            };
            
            const updateDashboard = (data) => {
                renderKpis(data);
                renderCharts(data);
                renderTable(data);
            }

            // --- MANIPULADORES DE EVENTOS ---

            filterBtn.addEventListener('click', applyFilters);

            clearFilterBtn.addEventListener('click', () => {
                filterConsultor.value = '';
                filterSituacao.value = '';
                startDateInput.value = '';
                endDateInput.value = '';
                updateDashboard(leads);
            });

            kpiContainer.addEventListener('click', (e) => {
                const kpiCard = e.target.closest('[data-filter-value]');
                if (!kpiCard) return;

                const filterValue = kpiCard.dataset.filterValue;

                if(filterValue === '') {
                    filterSituacao.value = '';
                } else {
                    const option = Array.from(filterSituacao.options).find(opt => 
                        opt.textContent.toLowerCase().includes(filterValue)
                    );
                    filterSituacao.value = option ? option.value : '';
                }
                
                applyFilters();
            });


            tableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button || button.dataset.action !== 'view') return;

                const id = button.dataset.id;
                const leadToView = leads.find(l => l.id == id);
                if (leadToView) {
                    currentLeadInView = leadToView;
                    observationContent.textContent = leadToView.observacao || 'Nenhuma observação registada.';
                    geminiResultContainer.classList.add('hidden');
                    geminiResultContent.innerHTML = '';
                    observationModal.classList.remove('hidden');
                }
            });

            summarizeBtn.addEventListener('click', () => {
                if (currentLeadInView?.observacao) {
                    const prompt = `Resuma as seguintes observações de um lead comercial em 2 ou 3 pontos principais, em português. Seja conciso e direto:\n\n"${currentLeadInView.observacao}"`;
                    callGeminiAPI(prompt, geminiResultContainer, geminiLoader, geminiResultContent);
                } else {
                    geminiResultContent.textContent = 'Não há observações para resumir.';
                    geminiResultContainer.classList.remove('hidden');
                }
            });

            suggestBtn.addEventListener('click', () => {
                if (currentLeadInView) {
                    const prompt = `Aja como um gestor de vendas experiente. Para um lead com a situação "${currentLeadInView.situacao}" e as seguintes observações: "${currentLeadInView.observacao || 'Nenhuma observação anterior'}", sugira um próximo passo claro e acionável para o consultor. Responda em português.`;
                    callGeminiAPI(prompt, geminiResultContainer, geminiLoader, geminiResultContent);
                }
            });

            strategicAnalysisBtn.addEventListener('click', () => {
                strategicModal.classList.remove('hidden');
                const dataToAnalyze = leads;

                if (dataToAnalyze.length === 0) {
                     strategicResultContent.textContent = "Não há dados de leads para analisar. Por favor, carregue os dados primeiro.";
                     return;
                }

                const leadsDataForPrompt = dataToAnalyze.map(l => ` - Situação: ${l.situacao}, Indicação: ${l.indicacao}, Consultor: ${l.consultor}`).join('\n');
                const prompt = `Aja como um diretor de vendas. Analise os seguintes dados de leads de uma equipa comercial.\n\nDados:\n${leadsDataForPrompt}\n\nCom base nestes dados, identifique:\n1. **Pontos Fortes:** Quais são as fontes de leads (indicação) mais eficazes ou as situações que estão a levar a bons resultados?\n2. **Pontos Fracos:** Onde é que o processo de vendas parece estar a falhar? Há algum padrão nos leads perdidos ou estagnados?\n3. **Sugestão Acionável:** Dê uma sugestão estratégica e clara para a equipa melhorar os seus resultados no próximo mês.\n\nResponda em português com uma formatação clara usando títulos para cada secção.`;
                
                callGeminiAPI(prompt, document.getElementById('strategic-content'), strategicLoader, strategicResultContent);
            });

            function closeModal(modal) {
                modal.classList.add('hidden');
            }

            closeObservationBtn.addEventListener('click', () => closeModal(observationModal));
            observationModal.addEventListener('click', (e) => {
                if (e.target === observationModal) closeModal(observationModal);
            });
            
            closeStrategicBtn.addEventListener('click', () => closeModal(strategicModal));
            strategicModal.addEventListener('click', (e) => {
                if (e.target === strategicModal) closeModal(strategicModal);
            });

            // --- INICIALIZAÇÃO ---
            fetchSheetData();
        });
    </script>
</body>
</html>