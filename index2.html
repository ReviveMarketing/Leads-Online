<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Leads Online (Conectado)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .gemini-response {
            white-space: pre-wrap; /* Allows line breaks and spacing */
        }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .main-loader {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="loader-screen" class="main-loader">
        <div class="loader"></div>
        <p class="mt-4 text-slate-600">Carregando dados da planilha...</p>
    </div>

    <div id="dashboard-content" class="container mx-auto p-4 md:p-8 hidden">
        <!-- Cabeçalho -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900">Dashboard de Leads Online</h1>
            <p class="text-slate-500 mt-1">Visão em tempo real do desempenho da equipe e dos canais de aquisição.</p>
        </header>

        <!-- Seção de KPIs Principais (Cartões) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="text-sm font-medium text-slate-500">Total de Leads</h3>
                <p id="kpi-total-leads" class="text-3xl font-bold mt-2">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="text-sm font-medium text-slate-500">Em Negociação</h3>
                <p id="kpi-em-negociacao" class="text-3xl font-bold mt-2">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="text-sm font-medium text-slate-500">Leads Fechados</h3>
                <p id="kpi-fechados" class="text-3xl font-bold mt-2">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="text-sm font-medium text-slate-500">Sem Possibilidade</h3>
                <p id="kpi-sem-possibilidade" class="text-3xl font-bold mt-2">0</p>
            </div>
        </div>
        
        <!-- NOVA SEÇÃO: Análise Inteligente com Gemini -->
        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-8">
            <h3 class="font-semibold text-slate-800 mb-4 text-lg">Análise Inteligente com Gemini</h3>
            <div class="flex flex-wrap gap-4 mb-4">
                <button id="generateSummaryBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
                    ✨ Gerar Resumo de Performance
                </button>
                <button id="generateActionsBtn" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition-colors flex items-center gap-2">
                    ✨ Sugerir Ações de Melhoria
                </button>
            </div>
            <div id="geminiOutput" class="bg-slate-100 p-4 rounded-lg min-h-[100px] text-sm text-slate-700 border border-slate-200">
                <div id="geminiPlaceholder" class="text-slate-500">Clique em um dos botões acima para receber insights gerados por IA sobre seus dados.</div>
                <div id="geminiLoader" class="hidden flex items-center justify-center py-4">
                    <div class="loader"></div>
                    <p class="ml-4 text-slate-500">Analisando dados...</p>
                </div>
                <div id="geminiResponse" class="gemini-response"></div>
            </div>
        </div>

        <!-- Seção de Gráficos -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
            <!-- Coluna Esquerda -->
            <div class="lg:col-span-3 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-semibold text-slate-800 mb-4">Volume de Leads por Dia (Últimos 30 dias)</h3>
                <div class="chart-container" style="height: 320px;">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>
            <!-- Coluna Direita -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-semibold text-slate-800 mb-4">Leads por Situação</h3>
                 <div class="chart-container" style="height: 320px;">
                    <canvas id="situacaoChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
             <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-semibold text-slate-800 mb-4">Origem dos Leads (Canais)</h3>
                <div class="chart-container">
                    <canvas id="origemChart"></canvas>
                </div>
            </div>
             <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-semibold text-slate-800 mb-4">Desempenho por Consultor</h3>
                <div class="chart-container">
                    <canvas id="consultorChart"></canvas>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- PASSO MAIS IMPORTANTE ---
        // URL DA PLANILHA PUBLICADA (USANDO API GVIZ PARA EVITAR ERRO DE CORS)
        const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/15G9YGn6BJ89bpx6MkZBhOiRiwiSPOX3qZ4A8SQvf1Wg/gviz/tq?tqx=out:csv'; 
        
        let situacaoData, consultorData, origemData, volumeData, rawData;
        let charts = {};

        // Função principal que inicia o processo
        document.addEventListener('DOMContentLoaded', async () => {
            if (!googleSheetUrl) {
                document.getElementById('loader-screen').innerHTML = `
                    <p class="text-red-600 font-semibold">ERRO: A URL da planilha não foi configurada.</p>
                    <p class="text-slate-600 mt-2">Siga as instruções para publicar sua planilha e cole o link na variável 'googleSheetUrl'.</p>
                `;
                return;
            }
            rawData = await fetchData(googleSheetUrl);
            if(rawData) {
                processAllData(rawData);
                initializeCharts();
                updateKPIs();
                document.getElementById('loader-screen').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');
            }
        });

        // Função para buscar e parsear os dados da planilha
        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const cleanCsvText = csvText.replace(/\r/g, "");
                const lines = cleanCsvText.trim().split('\n');
                
                const parseCsvLine = (line) => {
                    return line.split(',').map(v => {
                        let value = v.trim();
                        if (value.startsWith('"') && value.endsWith('"')) {
                            value = value.substring(1, value.length - 1);
                        }
                        return value;
                    });
                };
                
                const headers = parseCsvLine(lines[0]);
                
                const data = lines.slice(1).map(line => {
                    const values = parseCsvLine(line);
                    let obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = values[i];
                    });
                    return obj;
                });
                return data.filter(item => item.DATA && item.DATA.length > 0); // Filtra linhas vazias
            } catch (error) {
                console.error('Erro ao buscar ou processar dados da planilha:', error);
                 document.getElementById('loader-screen').innerHTML = `
                    <p class="text-red-600 font-semibold">Falha ao carregar os dados.</p>
                    <p class="text-slate-600 mt-2">Verifique se o link da planilha está correto e se ela foi publicada como CSV.</p>
                `;
                return null;
            }
        }


        // Função para processar os dados brutos para os formatos dos gráficos
        function processAllData(data) {
            const countOccurrences = (arr, key) => arr.reduce((acc, item) => {
                const itemKey = item[key];
                if (itemKey) { // Garante que a chave não seja vazia ou undefined
                    acc[itemKey] = (acc[itemKey] || 0) + 1;
                }
                return acc;
            }, {});

            const situacaoCounts = countOccurrences(data, 'SITUAÇÃO');
            situacaoData = {
                labels: Object.keys(situacaoCounts),
                values: Object.values(situacaoCounts)
            };

            const consultorCounts = countOccurrences(data, 'CONSULTOR');
            consultorData = {
                labels: Object.keys(consultorCounts),
                values: Object.values(consultorCounts)
            };

            const origemCounts = countOccurrences(data, 'INDICAÇÃO');
            origemData = {
                labels: Object.keys(origemCounts),
                values: Object.values(origemCounts)
            };
            
            // Processa volume por dia (últimos 30 dias)
            const volumeCounts = data.reduce((acc, item) => {
                const dateStr = item.DATA; // Assumindo formato DD/MM/YYYY ou similar
                if (dateStr) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                       const day = parseInt(parts[0], 10);
                       const month = parseInt(parts[1], 10) -1; // Mês no JS é 0-11
                       const year = parseInt(parts[2], 10);
                       const date = new Date(year, month, day);

                       const today = new Date();
                       today.setHours(0,0,0,0);
                       const thirtyDaysAgo = new Date();
                       thirtyDaysAgo.setDate(today.getDate() - 30);
                       thirtyDaysAgo.setHours(0,0,0,0);

                       if (date >= thirtyDaysAgo && date <= today) {
                          const formattedDate = `${String(day).padStart(2,'0')}/${String(month+1).padStart(2,'0')}/${year}`;
                          acc[formattedDate] = (acc[formattedDate] || 0) + 1;
                       }
                    }
                }
                return acc;
            }, {});

            const sortedVolume = Object.entries(volumeCounts).sort((a, b) => {
                 const dateA = new Date(a[0].split('/').reverse().join('-'));
                 const dateB = new Date(b[0].split('/').reverse().join('-'));
                 return dateA - dateB;
            });

            volumeData = {
                labels: sortedVolume.map(item => item[0].substring(0,5)), // Mostra só DD/MM
                values: sortedVolume.map(item => item[1])
            };
        }
        
        function updateKPIs() {
            document.getElementById('kpi-total-leads').textContent = rawData.length;
            const negociacaoCount = situacaoData.labels.indexOf('NEGOCIAÇÃO') > -1 ? situacaoData.values[situacaoData.labels.indexOf('NEGOCIAÇÃO')] : (situacaoData.labels.indexOf('Negociação') > -1 ? situacaoData.values[situacaoData.labels.indexOf('Negociação')] : 0);
            const fechadoCount = situacaoData.labels.indexOf('FECHADO') > -1 ? situacaoData.values[situacaoData.labels.indexOf('FECHADO')] : 0;
            const semPossibilidadeCount = situacaoData.labels.indexOf('SEM POSSIBILIDADE') > -1 ? situacaoData.values[situacaoData.labels.indexOf('SEM POSSIBILIDADE')] : 0;
            
            document.getElementById('kpi-em-negociacao').textContent = negociacaoCount;
            document.getElementById('kpi-fechados').textContent = fechadoCount;
            document.getElementById('kpi-sem-possibilidade').textContent = semPossibilidadeCount;
        }

        // --- LÓGICA DA API GEMINI ---
        const generateSummaryBtn = document.getElementById('generateSummaryBtn');
        const generateActionsBtn = document.getElementById('generateActionsBtn');
        const geminiPlaceholder = document.getElementById('geminiPlaceholder');
        const geminiLoader = document.getElementById('geminiLoader');
        const geminiResponse = document.getElementById('geminiResponse');

        const callGeminiAPI = async (prompt) => {
            geminiPlaceholder.classList.add('hidden');
            geminiResponse.textContent = '';
            geminiLoader.classList.remove('hidden');

            const apiKey = ""; // Canvas will provide the key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                geminiResponse.textContent = text || "Não foi possível obter uma resposta da IA.";

            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                geminiResponse.textContent = "Ocorreu um erro ao tentar analisar os dados. Por favor, tente novamente mais tarde.";
            } finally {
                geminiLoader.classList.add('hidden');
            }
        };

        generateSummaryBtn.addEventListener('click', () => {
            const prompt = `
                Você é um analista de vendas sênior. Analise os seguintes dados de um dashboard de leads e escreva um resumo conciso (em 2-3 parágrafos) sobre a performance atual. Destaque os pontos positivos e os que precisam de atenção. Seja direto e use os dados para embasar sua análise.

                Dados:
                - Situação dos Leads: ${JSON.stringify(situacaoData)}
                - Performance por Consultor: ${JSON.stringify(consultorData)}
                - Origem dos Leads por Canal: ${JSON.stringify(origemData)}
                - Volume de Novos Leads nos últimos dias: ${JSON.stringify(volumeData.values)}

                Resumo da Performance:
            `;
            callGeminiAPI(prompt);
        });

        generateActionsBtn.addEventListener('click', () => {
             const prompt = `
                Você é um consultor de estratégia de vendas. Com base nos dados de performance de leads a seguir, sugira 3 ações práticas e específicas para melhorar os resultados da equipe. Justifique cada sugestão com base nos dados. Formate a resposta como uma lista com marcadores (usando *).

                Dados:
                - Situação dos Leads: ${JSON.stringify(situacaoData)}
                - Performance por Consultor: ${JSON.stringify(consultorData)}
                - Origem dos Leads por Canal: ${JSON.stringify(origemData)}
                - Volume de Novos Leads nos últimos dias: ${JSON.stringify(volumeData.values)}

                Ações Sugeridas:
            `;
            callGeminiAPI(prompt);
        });


        // --- Configuração dos Gráficos ---
        function initializeCharts(){
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                               family: "'Inter', sans-serif"
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { font: { family: "'Inter', sans-serif" }}
                    },
                    y: {
                        grid: { 
                            color: '#e2e8f0',
                            borderDash: [3, 3]
                        },
                        ticks: { font: { family: "'Inter', sans-serif" }},
                        beginAtZero: true
                    }
                }
            };

            // 1. Gráfico de Situação (Rosca/Donut)
            charts.situacao = new Chart(document.getElementById('situacaoChart'), {
                type: 'doughnut',
                data: {
                    labels: situacaoData.labels,
                    datasets: [{
                        label: 'Leads',
                        data: situacaoData.values,
                        backgroundColor: ['#3b82f6', '#ef4444', '#22c55e', '#a855f7', '#f97316', '#14b8a6'],
                        borderColor: '#fff',
                        borderWidth: 4
                    }]
                },
                options: {
                    ...defaultOptions,
                    plugins: { ...defaultOptions.plugins, legend: { position: 'right' }},
                    cutout: '60%',
                    scales: { x: { display: false }, y: { display: false }}
                }
            });

            // 2. Gráfico de Desempenho por Consultor (Barras)
            charts.consultor = new Chart(document.getElementById('consultorChart'), {
                type: 'bar',
                data: {
                    labels: consultorData.labels,
                    datasets: [{
                        label: 'Leads Ativos',
                        data: consultorData.values,
                        backgroundColor: '#6366f1',
                        borderRadius: 4
                    }]
                },
                options: { ...defaultOptions, plugins: { legend: { display: false }}}
            });

            // 3. Gráfico de Origem dos Leads (Barras Horizontais)
            charts.origem = new Chart(document.getElementById('origemChart'), {
                type: 'bar',
                data: {
                    labels: origemData.labels,
                    datasets: [{
                        label: 'Número de Leads',
                        data: origemData.values,
                        backgroundColor: ['#14b8a6', '#0ea5e9', '#8b5cf6', '#f97316' ],
                        borderRadius: 4
                    }]
                },
                options: {
                    ...defaultOptions,
                    indexAxis: 'y', // <-- Torna o gráfico horizontal
                    plugins: { legend: { display: false }}
                }
            });
            
            // 4. Gráfico de Volume de Leads (Linha/Área)
            charts.volume = new Chart(document.getElementById('volumeChart'), {
                type: 'line',
                data: {
                    labels: volumeData.labels,
                    datasets: [{
                        label: 'Novos Leads',
                        data: volumeData.values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4, // Suaviza a linha
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointHoverRadius: 6,
                        pointRadius: 4,
                    }]
                },
                options: {
                    ...defaultOptions,
                    plugins: { legend: { display: false }}
                }
            });
        }
    </script>
</body>
</html>